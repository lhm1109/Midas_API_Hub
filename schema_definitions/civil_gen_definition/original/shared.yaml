# ============================================================================
# SHARED RULES - Original Schemaìš© ê³µí†µ ê·œì¹™ (SSOT v1.5)
# ============================================================================
# ğŸ”¥ Original: ìˆœìˆ˜ JSON Schema Draft-07ë§Œ ì§€ì›
#    - x-* extensions ë¯¸ì‚¬ìš© (í‘œì¤€ í˜¸í™˜)
#    - Enhancedì—ì„œ ì»¨ë²„í„°ë¡œ ë³€í™˜ ì‹œ x-* ë§ˆì»¤ê°€ ëª¨ë‘ ì œê±°ë¨
#
# ğŸ”¥ Enhancedì™€ì˜ ì°¨ì´ì :
#    - markerRegistry: ë¹ˆ ë°°ì—´ (x-* ë§ˆì»¤ ë¯¸ì§€ì›)
#    - typeInferenceRegistry: ë¹ˆ ë°°ì—´ (ì ‘ë‘ì‚¬ ê¸°ë°˜ íƒ€ì… ì¶”ë¡  ë¯¸ì§€ì›)
#    - conditionRegistry: ìµœì†Œ ì„¸íŠ¸ë§Œ ìœ ì§€ (has-marker ë“± ì œì™¸)
#    - visibilityRules: ì¡°ê±´ë¶€ í•„ë“œ í‘œì‹œ ë¯¸ì§€ì›
#
# âš ï¸ SSOT ì›ì¹™:
#   - ë²„ì „: versioning ì„¹ì…˜ë§Œ ì±…ì„
#   - ì„¹ì…˜/ê·¸ë£¹: sectionRegistry + schemaLogic.sectionRules
#   - ë˜í¼: wrapperRegistry + wrapperRegistryPolicy
#   - ì¡°ê±´: conditionRegistry (ì „ì—­ SSOT)
#   - ë¬´ê²°ì„±: integrityRules (ë ˆí¼ëŸ°ìŠ¤ ê²€ì¦)
# ============================================================================


# ============================================================================
# VERSIONING
# ============================================================================
versioning:
  rulesSpecVersion: "1.5.0"  # ğŸ”¥ SSOT 100ì  ë²„ì „
  inputSpec:
    schemaDraft: "draft-07"
    min: "1.0"
    max: "1.x"

# ============================================================================
# UNKNOWN POLICY
# ============================================================================
unknownPolicy:
  transform:
    action: "passthrough"
    collectUnknown: true
  validate:
    unknownKey: "warn"
    unknownMarker: "allow"    # originalì—ëŠ” x-* ë§ˆì»¤ ì—†ìŒ
    unsupportedStructure: "warn"

# ============================================================================
# DEFAULT HANDLERS
# ============================================================================
defaultHandlers:
  typeInferenceFallback:
    type: "string"
    warn: true
  
  missingXui:
    label: "{key}"
    warn: true
  
  wrapperPriorityDefault: 0

# ============================================================================
# PRECEDENCE
# ============================================================================
precedence:
  order:
    - explicit
    - product
    - shared
    - inference
  merge:
    sameKey: "override"
    list: "replace"
    missingKey: "inherit"

# ============================================================================
# INTEGRITY RULES - ë ˆí¼ëŸ°ìŠ¤ ë¬´ê²°ì„± (SSOT)
# ============================================================================
integrityRules:
  requireMarkerIdInRegistry: false     # originalì—ëŠ” marker ì—†ìŒ
  requireSectionIdInRegistry: true
  requireConditionTypeInRegistry: true
  requireXuiSectionIdInRegistry: false # originalì—ëŠ” x-ui ì—†ìŒ

# ============================================================================
# REGISTRIES
# ============================================================================

# Marker Registry - originalì—ëŠ” x-* ë§ˆì»¤ ì—†ìŒ (ë¹ˆ ë°°ì—´)
markerRegistry: []

# Condition Registry (ì „ì—­ SSOT) - originalìš© ìµœì†Œ ì„¸íŠ¸
conditionRegistry:
  - type: "has-enum"
    requiredParams: []
    description: "ëª…ì‹œì  enum ë°°ì—´ ì¡´ì¬ ì‹œ true"

  - type: "has-oneOf-with-const"
    requiredParams: []
    description: "oneOf ë‚´ë¶€ì— const ì†ì„± ì¡´ì¬ ì‹œ true"

  - type: "always"
    requiredParams: []
    description: "í•­ìƒ true (ê¸°ë³¸ fallback)"

# Section Registry (SSOT)
sectionRegistry:
  - id: SECTION_GENERAL
    name: "General"
    description: "ê¸°ë³¸ ì„¹ì…˜"
    isDefault: true

  - id: SECTION_OPTIONS
    name: "Options"
    description: "ì˜µì…˜ ì„¹ì…˜"

  - id: SECTION_ADVANCED
    name: "Advanced"
    description: "ê³ ê¸‰ ì„¤ì •"

# Wrapper Registry Policy
wrapperRegistryPolicy:
  sort: "priorityDescStable"
  match: "first"

# Wrapper Registry (SSOT)
wrapperRegistry:
  - id: WRAP_DB
    pattern: "^/db/"
    wrapper: "Assign"
    priority: 10

  - id: WRAP_POST
    pattern: "^/post/"
    wrapper: "Argument"
    priority: 10

  - id: WRAP_DEFAULT
    pattern: ".*"
    wrapper: null
    priority: -1

# Type Inference Registry (SSOT) - originalì—ëŠ” prefix ì¶”ë¡  ì—†ìŒ (ë¹ˆ ë°°ì—´)
typeInferenceRegistry: []

# Component Registry
componentRegistry:
  string:
    component: "Input"
    props: { type: "text" }

  number:
    component: "Input"
    props: { type: "number" }

  integer:
    component: "Input"
    props: { type: "number" }

  boolean:
    component: "Checkbox"
    props: {}

  array:
    component: "Textarea"
    props: { placeholder: "Enter as JSON array" }

  object:
    component: "Textarea"
    props: { placeholder: "Enter as JSON object" }

  enum:
    component: "Select"
    props: {}

# ============================================================================
# NAMING
# ============================================================================
naming:
  yamlKeyPolicy:
    min: 3
    max: 20
    style: "camelCase"
  
  fieldNamePolicy:
    # prefixSource ì—†ìŒ = originalì—ëŠ” íƒ€ì… ì¶”ë¡  ì—†ìŒ
    allowUppercase: true
    maxLength: 30
  
  conflict:
    strategy: "suffix"
    format: "_{n}"

# ============================================================================
# OUTPUT META
# ============================================================================
outputMeta:
  defaults:
    required: false
    onMissing: "null"
  fields:
    - alias: "rulesSpecVersion"
      source: "versioning.rulesSpecVersion"
    - alias: "sourceHash"
      source: "_computed.sourceHash"
    - alias: "generatedAt"
      source: "_computed.generatedAt"

# ============================================================================
# DIAGNOSTICS
# ============================================================================
diagnostics:
  errors:
    - code: "INVALID_FIELD_NAME_POLICY"
      level: "error"
      message: "í•„ë“œëª… ì •ì±… ìœ„ë°˜: {field}"

    - code: "INVALID_YAML_KEY_POLICY"
      level: "error"
      message: "YAML í‚¤ ì •ì±… ìœ„ë°˜: {key}"

  warnings:
    - code: "UNKNOWN_KEY"
      level: "warn"
      message: "ì•Œ ìˆ˜ ì—†ëŠ” í‚¤: {key}"

# ============================================================================
# SCHEMA LOGIC
# ============================================================================
schemaLogic:
  platformSkeleton:
    entityCollection:
      description: "Platform Standard Collection Map"
      type: "object"
      patternProperties:
        pattern: "^[0-9]+$"
        description: "Entity ID (numeric)"
        ref: "#/$defs/entity"
      additionalProperties: false
      minProperties: 0
    defaultBodyRoot: "Assign"
    alternativeBodyRoots:
      - "Argument"
      - "Assign"
    rootStructure:
      type: "object"
      additionalProperties: false

  schemaStructurePatterns:
    # ğŸ”¥ Pattern 1: Assign + additionalProperties (NEW)
    # Map ê¸°ë°˜ ì—”í‹°í‹° ì»¬ë ‰ì…˜ì„ ì–¸ë˜í•‘
    - name: "Unwrap Wrapper with AdditionalProperties"
      description: "Assign/Argument ë˜í¼ì˜ additionalPropertiesì—ì„œ ì—”í‹°í‹° ìŠ¤í‚¤ë§ˆ ì¶”ì¶œ"
      enabled: true
      priority: 0  # ê°€ì¥ ë¨¼ì € ì²´í¬
      detect:
        - path: "type"
          value: "object"
        - path: "properties.Assign.additionalProperties"
          exists: true
        - path: "properties.Assign.additionalProperties.type"
          value: "object"
      transform:
        action: "unwrap-wrapper-with-additionalProperties"
        
    # ğŸ”¥ Pattern 1b: Argument ë˜í¼ (Assign ëŒ€ì•ˆ)
    - name: "Unwrap Argument Wrapper with AdditionalProperties"
      description: "Argument ë˜í¼ì˜ additionalPropertiesì—ì„œ ì—”í‹°í‹° ìŠ¤í‚¤ë§ˆ ì¶”ì¶œ"
      enabled: true
      priority: 0
      detect:
        - path: "type"
          value: "object"
        - path: "properties.Argument.additionalProperties"
          exists: true
        - path: "properties.Argument.additionalProperties.type"
          value: "object"
      transform:
        action: "unwrap-wrapper-with-additionalProperties"

    # Pattern 2: ê¸°ì¡´ unwrap-root-key
    - name: "Unwrap Root Wrapper Key"
      description: "ìµœìƒìœ„ wrapper key ì œê±°"
      enabled: true
      priority: 1
      detect:
        - path: "type"
          exists: false
        - path: "properties"
          exists: false
      transform:
        action: "unwrap-root-key"
        extractTitle: true
        preserveMetadata: ["$schema", "description"]
    
    - name: "Root oneOf"
      description: "ìµœìƒìœ„ oneOf íŒ¨í„´"
      enabled: true
      detect:
        - path: "oneOf"
          exists: true
          isArray: true
        - path: "properties"
          exists: false
      transform:
        action: "wrap-in-virtual-object"
        wrapperKey: "{title}"
        wrapperType: "object"

  # ğŸ”¥ v1.5: sectionId ì°¸ì¡°
  sectionRules:
    - name: "Default Section"
      description: "ê¸°ë³¸ ì„¹ì…˜ (sectionRegistry SSOT)"
      condition:
        type: "always"
      action:
        type: "assign-section"
        sectionId: "SECTION_GENERAL"

  # ğŸ”¥ v1.5: sectionRegistry.id ì°¸ì¡°
  sectionOrder:
    - "SECTION_GENERAL"
    - "SECTION_OPTIONS"
    - "SECTION_ADVANCED"

  typeLabels:
    string: "String"
    number: "Number"
    integer: "Integer"
    boolean: "Boolean"
    array: "Array"
    object: "Object"

  # ğŸ”¥ êµ¬ì¡°í™”ëœ condition ì‚¬ìš©
  enumDetectionRules:
    - id: ENUM_EXPLICIT
      condition:
        type: "has-enum"
      description: "ëª…ì‹œì  enum ë°°ì—´ì´ ìˆìœ¼ë©´ enum"
    - id: ENUM_ONEOF_CONST
      condition:
        type: "has-oneOf-with-const"
      description: "oneOf ë‚´ë¶€ì— constê°€ ìˆìœ¼ë©´ enum"

  visibilityRules: []

  requiredCalculationRules:
    defaultStatus: "optional"
    conditionalRequired:
      enabled: true
      sources:
        - "allOf[].if.properties"
        - "allOf[].then.required"

  validationLayerRules:
    STD:
      description: "Standard JSON Schema Validation"
      triggers:
        - condition:
            type: "always"

  descriptionBuildingRules:
    format: "simple"
    includeElements:
      - "description"
      - "enum"
      - "default"
    excludeExtensions: true

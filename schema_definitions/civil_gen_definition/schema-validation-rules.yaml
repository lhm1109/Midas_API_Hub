# Schema Validation Rules
# ìŠ¤í‚¤ë§ˆ ì‘ì„± ê·œì¹™ì„ YAMLë¡œ ì •ì˜í•˜ì—¬ ìë™ ê²€ì¦

version: "1.0"
description: "Enhanced JSON Schema ì‘ì„± ê·œì¹™ ë° ê²€ì¦ ê·œì¹™"

# ============================================================================
# í•„ìˆ˜ ê·œì¹™ (MUST)
# ============================================================================
mustRules:
  - id: "single-entity-schema"
    name: "Single Entity Schema ì›ì¹™"
    description: "ìŠ¤í‚¤ë§ˆëŠ” ë‹¨ì¼ ì—”í‹°í‹°ë§Œ ì •ì˜í•´ì•¼ í•˜ë©°, ë˜í¼ëŠ” x-transportë¡œ ì²˜ë¦¬"
    severity: "error"
    category: "structure"
    
    checks:
      - type: "no-wrapper-in-properties"
        message: "ìµœìƒìœ„ propertiesì— ë˜í¼ ê°ì²´(Assign, Argument ë“±)ê°€ ìˆìŠµë‹ˆë‹¤."
        explanation: |
          ìŠ¤í‚¤ë§ˆëŠ” ë‹¨ì¼ ì—”í‹°í‹°ë¥¼ ì •ì˜í•©ë‹ˆë‹¤. ë˜í¼ëŠ” x-transport.body-rootë¡œ ì²˜ë¦¬í•˜ì„¸ìš”.
          
          âŒ ì˜ëª»ë¨:
          {
            "properties": {
              "Argument": { "properties": { ... } }
            }
          }
          
          âœ… ì˜¬ë°”ë¦„:
          {
            "properties": { "TABLE_NAME": { ... } },
            "x-transport": { "body-root": "Argument" }
          }
        
        detect:
          # properties ì•ˆì— ë‹¨ì¼ ê°ì²´ë§Œ ìˆê³ , ê·¸ê²ƒì´ ì•Œë ¤ì§„ ë˜í¼ì¸ ê²½ìš°
          conditions:
            - path: "properties"
              count: 1
              childType: "object"
              childName: ["Assign", "Argument", "Data", "Body"]
        
        fix:
          action: "flatten-wrapper"
          steps:
            - "ë˜í¼ ê°ì²´ì˜ propertiesë¥¼ ìµœìƒìœ„ë¡œ ì´ë™"
            - "ë˜í¼ ê°ì²´ì˜ requiredë¥¼ ìµœìƒìœ„ë¡œ ì´ë™"
            - "x-transport.body-rootì— ë˜í¼ ì´ë¦„ ì¶”ê°€"
  
  - id: "no-nested-required"
    name: "Required ì¤‘ì²© ê¸ˆì§€"
    description: "required ë°°ì—´ì€ ìµœìƒìœ„ì—ë§Œ ìˆì–´ì•¼ í•¨"
    severity: "error"
    category: "structure"
    
    checks:
      - type: "required-at-root-only"
        message: "required ë°°ì—´ì´ ì¤‘ì²©ëœ ê°ì²´ ì•ˆì— ìˆìŠµë‹ˆë‹¤."
        explanation: |
          required ë°°ì—´ì€ ìµœìƒìœ„ì—ë§Œ ì •ì˜í•´ì•¼ í•©ë‹ˆë‹¤.
          
          âŒ ì˜ëª»ë¨:
          {
            "properties": {
              "Argument": {
                "required": ["TABLE_TYPE"]
              }
            }
          }
          
          âœ… ì˜¬ë°”ë¦„:
          {
            "required": ["TABLE_TYPE"],
            "properties": { ... }
          }
        
        detect:
          conditions:
            - path: "properties.*.required"
              exists: true
        
        fix:
          action: "move-required-to-root"
          steps:
            - "ì¤‘ì²©ëœ required ë°°ì—´ì„ ìµœìƒìœ„ë¡œ ì´ë™"
  
  - id: "no-dot-notation-in-allof"
    name: "allOfì—ì„œ ì  í‘œê¸°ë²• ê¸ˆì§€"
    description: "allOf ì¡°ê±´ì—ì„œ ì¤‘ì²© ê²½ë¡œë¥¼ ì‚¬ìš©í•˜ì§€ ì•Šì•„ì•¼ í•¨"
    severity: "error"
    category: "validation"
    
    checks:
      - type: "no-nested-path-in-allof"
        message: "allOfì˜ requiredì—ì„œ ì  í‘œê¸°ë²•(ì˜ˆ: 'Argument.STAGE_STEP')ì„ ì‚¬ìš©í•˜ê³  ìˆìŠµë‹ˆë‹¤."
        explanation: |
          allOfëŠ” ìµœìƒìœ„ í•„ë“œë§Œ ì°¸ì¡°í•´ì•¼ í•©ë‹ˆë‹¤.
          
          âŒ ì˜ëª»ë¨:
          {
            "allOf": [{
              "then": { "required": ["Argument.STAGE_STEP"] }
            }]
          }
          
          âœ… ì˜¬ë°”ë¦„:
          {
            "allOf": [{
              "then": { "required": ["STAGE_STEP"] }
            }]
          }
        
        detect:
          conditions:
            - path: "allOf.*.then.required.*"
              pattern: ".*\\..*"  # ì ì´ í¬í•¨ëœ ê²½ìš°
        
        fix:
          action: "remove-dot-notation"
          steps:
            - "ì  í‘œê¸°ë²•ì„ ë‹¨ìˆœ í•„ë“œëª…ìœ¼ë¡œ ë³€ê²½"
  
  - id: "transport-wrapper-consistency"
    name: "Transport ë˜í¼ ì¼ê´€ì„±"
    description: "x-transport.body-rootê°€ ì‹¤ì œ propertiesì— ì—†ì–´ì•¼ í•¨"
    severity: "error"
    category: "structure"
    
    checks:
      - type: "no-duplicate-wrapper"
        message: "x-transport.body-rootì— ì •ì˜ëœ ë˜í¼ê°€ propertiesì—ë„ ìˆìŠµë‹ˆë‹¤."
        explanation: |
          ë˜í¼ëŠ” x-transport.body-rootì—ë§Œ ì •ì˜í•˜ê³ , propertiesì—ëŠ” í¬í•¨í•˜ì§€ ë§ˆì„¸ìš”.
          
          âŒ ì˜ëª»ë¨:
          {
            "properties": { "Argument": { ... } },
            "x-transport": { "body-root": "Argument" }
          }
          
          âœ… ì˜¬ë°”ë¦„:
          {
            "properties": { "TABLE_NAME": { ... } },
            "x-transport": { "body-root": "Argument" }
          }
        
        detect:
          conditions:
            - path: "x-transport.body-root"
              valueInKeys: "properties"
        
        fix:
          action: "remove-wrapper-from-properties"

# ============================================================================
# ê¶Œì¥ ê·œì¹™ (SHOULD)
# ============================================================================
shouldRules:
  - id: "use-x-ui-for-labels"
    name: "x-uië¡œ ë ˆì´ë¸” ì •ì˜"
    description: "í•„ë“œ ë ˆì´ë¸”ì€ x-ui.labelë¡œ ì •ì˜ ê¶Œì¥"
    severity: "warning"
    category: "metadata"
    
    checks:
      - type: "missing-x-ui-label"
        message: "í•„ë“œì— x-ui.labelì´ ì—†ìŠµë‹ˆë‹¤. ì¶”ê°€ë¥¼ ê¶Œì¥í•©ë‹ˆë‹¤."
        explanation: |
          UIì—ì„œ í•„ë“œë¥¼ ë” ëª…í™•í•˜ê²Œ í‘œì‹œí•˜ë ¤ë©´ x-ui.labelì„ ì¶”ê°€í•˜ì„¸ìš”.
          
          âœ… ê¶Œì¥:
          {
            "TABLE_NAME": {
              "type": "string",
              "x-ui": {
                "label": "Table Name",
                "group": "General"
              }
            }
          }
        
        detect:
          conditions:
            - path: "properties.*"
              missing: "x-ui.label"
              exclude:
                - type: "object"  # ê°ì²´ëŠ” ì œì™¸
  
  - id: "use-x-ui-group"
    name: "x-ui.groupìœ¼ë¡œ ì„¹ì…˜ êµ¬ë¶„"
    description: "ê´€ë ¨ í•„ë“œëŠ” x-ui.groupìœ¼ë¡œ ê·¸ë£¹í™” ê¶Œì¥"
    severity: "info"
    category: "metadata"
    
    checks:
      - type: "missing-x-ui-group"
        message: "í•„ë“œì— x-ui.groupì´ ì—†ìŠµë‹ˆë‹¤. ì„¹ì…˜ êµ¬ë¶„ì„ ìœ„í•´ ì¶”ê°€ë¥¼ ê¶Œì¥í•©ë‹ˆë‹¤."
        explanation: |
          í•„ë“œë¥¼ ë…¼ë¦¬ì ìœ¼ë¡œ ê·¸ë£¹í™”í•˜ë©´ UIê°€ ë” ì§ê´€ì ì…ë‹ˆë‹¤.
          
          âœ… ê¶Œì¥:
          {
            "x-ui": {
              "label": "Table Name",
              "group": "General"
            }
          }
  
  - id: "use-standard-validation-first"
    name: "í‘œì¤€ JSON Schema ìš°ì„  ì‚¬ìš©"
    description: "ê²€ì¦ ë¡œì§ì€ í‘œì¤€ JSON Schemaë¡œ ìµœëŒ€í•œ í‘œí˜„"
    severity: "warning"
    category: "validation"
    
    checks:
      - type: "x-extension-for-validation"
        message: "x-* í™•ì¥ì„ ê²€ì¦ ë¡œì§ìœ¼ë¡œ ì‚¬ìš©í•˜ê³  ìˆìŠµë‹ˆë‹¤. ê°€ëŠ¥í•˜ë©´ í‘œì¤€ JSON Schemaë¥¼ ì‚¬ìš©í•˜ì„¸ìš”."
        explanation: |
          x-* í™•ì¥ì€ í‘œì¤€ JSON Schemaë¡œ í‘œí˜„í•  ìˆ˜ ì—†ëŠ” ê²½ìš°ì—ë§Œ ì‚¬ìš©í•˜ì„¸ìš”.
          
          âŒ í”¼í•´ì•¼ í•¨:
          {
            "SECT": {
              "x-required-for-types": ["BEAM", "WALL"]
            }
          }
          
          âœ… ê¶Œì¥:
          {
            "allOf": [{
              "if": {
                "properties": { "TYPE": { "enum": ["BEAM", "WALL"] } }
              },
              "then": { "required": ["SECT"] }
            }]
          }

# ============================================================================
# ê¸ˆì§€ ê·œì¹™ (MUST NOT)
# ============================================================================
mustNotRules:
  - id: "no-collection-in-schema"
    name: "ì»¬ë ‰ì…˜ ê¸ˆì§€"
    description: "ìŠ¤í‚¤ë§ˆëŠ” ë°°ì—´/ì»¬ë ‰ì…˜ì„ ìµœìƒìœ„ë¡œ ê°€ì§ˆ ìˆ˜ ì—†ìŒ"
    severity: "error"
    category: "structure"
    
    checks:
      - type: "root-is-not-array"
        message: "ìµœìƒìœ„ typeì´ 'array'ì…ë‹ˆë‹¤. ìŠ¤í‚¤ë§ˆëŠ” ë‹¨ì¼ ê°ì²´ë¥¼ ì •ì˜í•´ì•¼ í•©ë‹ˆë‹¤."
        explanation: |
          ìŠ¤í‚¤ë§ˆëŠ” í•˜ë‚˜ì˜ ì—”í‹°í‹°ë¥¼ ì •ì˜í•©ë‹ˆë‹¤. ì—¬ëŸ¬ ì¸ìŠ¤í„´ìŠ¤ëŠ” ì‹œìŠ¤í…œì´ ê´€ë¦¬í•©ë‹ˆë‹¤.
          
          âŒ ì˜ëª»ë¨:
          {
            "type": "array",
            "items": { "type": "object", ... }
          }
          
          âœ… ì˜¬ë°”ë¦„:
          {
            "type": "object",
            "properties": { ... }
          }
        
        detect:
          conditions:
            - path: "type"
              value: "array"
  
  - id: "no-validation-in-x-ui"
    name: "x-uiì— ê²€ì¦ ë¡œì§ ê¸ˆì§€"
    description: "x-uiëŠ” UI ë©”íƒ€ë°ì´í„°ë§Œ í¬í•¨"
    severity: "error"
    category: "metadata"
    
    checks:
      - type: "validation-keys-in-x-ui"
        message: "x-uiì— ê²€ì¦ ê´€ë ¨ í‚¤ì›Œë“œ(required, minimum, maximum ë“±)ê°€ ìˆìŠµë‹ˆë‹¤."
        explanation: |
          x-uiëŠ” UI ë Œë”ë§ ë©”íƒ€ë°ì´í„°ë§Œ í¬í•¨í•´ì•¼ í•©ë‹ˆë‹¤.
          ê²€ì¦ ë¡œì§ì€ í‘œì¤€ JSON Schemaë‚˜ x-value-constraintë¥¼ ì‚¬ìš©í•˜ì„¸ìš”.
          
          âŒ ì˜ëª»ë¨:
          {
            "x-ui": {
              "label": "Age",
              "required": true,
              "minimum": 0
            }
          }
          
          âœ… ì˜¬ë°”ë¦„:
          {
            "type": "integer",
            "minimum": 0,
            "x-ui": {
              "label": "Age"
            }
          }
        
        detect:
          conditions:
            - path: "properties.*.x-ui"
              hasAnyKey: ["required", "minimum", "maximum", "minLength", "maxLength", "pattern", "enum"]

# ============================================================================
# ë² ìŠ¤íŠ¸ í”„ë™í‹°ìŠ¤
# ============================================================================
bestPractices:
  - id: "use-description"
    name: "description ì¶”ê°€"
    severity: "info"
    message: "í•„ë“œì— descriptionì´ ì—†ìŠµë‹ˆë‹¤. ì¶”ê°€ë¥¼ ê¶Œì¥í•©ë‹ˆë‹¤."
  
  - id: "use-default-values"
    name: "default ê°’ ì œê³µ"
    severity: "info"
    message: "ì„ íƒì  í•„ë“œì— default ê°’ì„ ì¶”ê°€í•˜ë©´ ë” ì¢‹ìŠµë‹ˆë‹¤."
  
  - id: "use-x-enum-labels"
    name: "enumì— ë ˆì´ë¸” ì¶”ê°€"
    severity: "info"
    message: "enum í•„ë“œì— x-enum-labelsë¥¼ ì¶”ê°€í•˜ë©´ UIê°€ ë” ëª…í™•í•©ë‹ˆë‹¤."

# ============================================================================
# ê²€ì¦ ì‹¤í–‰ ì„¤ì •
# ============================================================================
validationConfig:
  # ê²€ì¦ ìˆ˜ì¤€
  levels:
    strict:
      - mustRules
      - mustNotRules
      - shouldRules
      - bestPractices
    
    standard:
      - mustRules
      - mustNotRules
      - shouldRules
    
    minimal:
      - mustRules
      - mustNotRules
  
  # ìë™ ìˆ˜ì • ê°€ëŠ¥ ì—¬ë¶€
  autoFix:
    enabled: true
    level: "mustRules"  # mustRulesë§Œ ìë™ ìˆ˜ì •
    confirmBeforeFix: true
  
  # ê²€ì¦ ì‹œì 
  validateOn:
    - upload
    - save
    - version-create
  
  # ì—ëŸ¬ ë³´ê³  í˜•ì‹
  errorReport:
    format: "detailed"  # detailed | summary
    includeFixSuggestions: true
    includeCodeExamples: true

# ============================================================================
# ì•Œë ¤ì§„ ë˜í¼ ëª©ë¡
# ============================================================================
knownWrappers:
  - "Assign"
  - "Argument"
  - "Data"
  - "Body"
  - "Payload"
  - "Request"
  - "Response"

# ============================================================================
# í—ˆìš©ëœ x-* í™•ì¥
# ============================================================================
allowedExtensions:
  standard:
    - "x-ui"
    - "x-transport"
    - "x-enum-labels"
    - "x-enum-by-type"
    - "x-enum-labels-by-type"
    - "x-value-constraint"
    - "x-node-count-by-type"
    - "x-exclusive-keys"
  
  ui:
    - "x-section-header"
    - "x-section-by-type"
    - "x-ui-hint"
    - "x-ui-group"
    - "x-ui-exclusive-group"
  
  validation:
    - "x-validation-layer"
    - "x-custom-validator"

# ============================================================================
# ê²€ì¦ ë©”ì‹œì§€ í…œí”Œë¦¿
# ============================================================================
messageTemplates:
  error: "ğŸš« [{severity}] {ruleName}: {message}"
  warning: "âš ï¸ [{severity}] {ruleName}: {message}"
  info: "â„¹ï¸ [{severity}] {ruleName}: {message}"
  
  detailedError: |
    â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    ğŸš« ì˜¤ë¥˜: {ruleName}
    â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    
    ìœ„ì¹˜: {path}
    ë©”ì‹œì§€: {message}
    
    ì„¤ëª…:
    {explanation}
    
    ìˆ˜ì • ë°©ë²•:
    {fixSteps}
    
    ì°¸ê³ : schema_definitions/manual/SCHEMA_CONTRACT_KO.md


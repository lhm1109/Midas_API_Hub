# ============================================================================
# ACCURACY POLICY - Evidence-Based Schema Generation
# ============================================================================
# ì´ íŒŒì¼ì€ MCP ìŠ¤í‚¤ë§ˆ ìƒì„± ì‹œ ì •í™•ë„ë¥¼ ë³´ì¥í•˜ê¸° ìœ„í•œ ì •ì±…ì„ ì •ì˜í•©ë‹ˆë‹¤.
# shared.yamlì„ í™•ì¥í•˜ì—¬ ì‚¬ìš©ë©ë‹ˆë‹¤.
# ============================================================================

version: "1.0.0"
extends: "./shared.yaml"

# ============================================================================
# EVIDENCE REQUIREMENTS - ê·¼ê±° ìš”êµ¬ì‚¬í•­
# ============================================================================
# íŠ¹ì • í•„ë“œ/íŒ¨í„´ì— ëŒ€í•´ ë°˜ë“œì‹œ ê·¼ê±°(evidence)ê°€ í•„ìš”í•¨ì„ ëª…ì‹œ
requireEvidenceFor:
  # Enum ê°’ ì •ì˜ ì‹œ ë°˜ë“œì‹œ ê·¼ê±° í•„ìš”
  - enum
  # ì¡°ê±´ë¶€ required ë¡œì§
  - conditionalRequired
  # Default ê°’ ì„¤ì • ì‹œ
  - defaultValue
  # oneOf íŒ¨í„´ ì‚¬ìš© ì‹œ
  - oneOf
  # x-enum-labels-by-type ì‚¬ìš© ì‹œ
  - enumLabelsByType

# ============================================================================
# EVIDENCE FORMAT - ê·¼ê±° í˜•ì‹ ì •ì˜
# ============================================================================
evidenceFormat:
  # ê·¼ê±° ì¶œì²˜
  source:
    type: "enum"
    values:
      - "doc"          # ë¬¸ì„œ (PDF, Word ë“±)
      - "image"        # UI ìŠ¤í¬ë¦°ìƒ·
      - "api_spec"     # API ëª…ì„¸ì„œ
      - "code"         # ê¸°ì¡´ ì½”ë“œ
      - "inferred"     # ì¶”ë¡  (ë‚®ì€ ì‹ ë¢°ë„)
  
  # ì°¸ì¡° ìœ„ì¹˜ (ì„ íƒì‚¬í•­)
  ref:
    type: "string"
    examples:
      - "Section 4.2"
      - "Page 3"
      - "Figure 12"
      - "Line 45-50"
    optional: true
  
  # ì •í™•í•œ ì¸ìš©ë¬¸ (ì„ íƒì‚¬í•­)
  quote:
    type: "string"
    description: "Exact text from source"
    optional: true
  
  # ì‹ ë¢°ë„
  confidence:
    type: "enum"
    values:
      - "high"    # ëª…ì‹œì ìœ¼ë¡œ ë¬¸ì„œì— ìˆìŒ
      - "medium"  # ë¬¸ì„œì—ì„œ ìœ ì¶” ê°€ëŠ¥
      - "low"     # ì¶”ì¸¡/ê´€í–‰

# ============================================================================
# AUTO-QUESTION PATTERNS - ìë™ ì§ˆë¬¸ ìƒì„± íŒ¨í„´
# ============================================================================
# íŠ¹ì • íŒ¨í„´ì´ ê°ì§€ë˜ë©´ ìë™ìœ¼ë¡œ ì§ˆë¬¸ì„ ìƒì„±
autoQuestionPatterns:
  # íŒ¨í„´ 1: Dropdownì— ì˜µì…˜ì´ 1ê°œë§Œ ë³´ì¼ ë•Œ
  - id: "dropdown_single_option"
    trigger:
      type: "enum_count"
      condition: "== 1"
      context: "User provides dropdown/enum with only one visible option"
    action:
      type: "require_question"
      priority: "high"
      questionTemplate: "What are all available options for this dropdown/enum field?"
      contextTemplate: "Image shows only '{firstValue}' selected/visible"
    example:
      field: "sDesignCode"
      enumSeen: ["AASHTO-LRFD20"]
      question: "What are all available Design Code options for the dropdown?"

  # íŒ¨í„´ 2: "User" ë˜ëŠ” "Custom" ê°’ ë°œê²¬
  - id: "user_custom_value"
    trigger:
      type: "keyword_detection"
      keywords: ["User", "Custom", "Manual", "Direct Input"]
      location: ["enum", "description", "label"]
    action:
      type: "require_question"
      priority: "medium"
      questionTemplate: "What is the expected value/format when user selects 'User/Custom' option?"
    example:
      field: "dEXP_FACT"
      trigger: "enum includes 'User'"
      question: "What value should be used when 'User' is selected?"

  # íŒ¨í„´ 3: TYPE ì¡°ê±´ + enum ë™ì‹œ ì¡´ì¬
  - id: "type_conditional_enum"
    trigger:
      type: "pattern_match"
      pattern: "TYPE dependency + enum field"
      condition: "allOf with TYPE condition and field has enum"
    action:
      type: "require_question"
      priority: "high"
      questionTemplate: "Please confirm enum values for all TYPE conditions"
    example:
      field: "STYPE"
      trigger: "enum varies by TYPE"
      question: "What are the STYPE options for each TYPE value?"

  # íŒ¨í„´ 4: Default ê°’ì´ ëª…ì‹œë˜ì§€ ì•ŠìŒ
  - id: "missing_default"
    trigger:
      type: "field_analysis"
      condition: "required field without default value"
      fieldTypes: ["integer", "number", "string"]
    # ğŸš¨ í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸: ì´ í•„ë“œë“¤ì€ default ì—†ì–´ë„ ì§ˆë¬¸í•˜ì§€ ì•ŠìŒ
    whitelist:
      - "TABLE_NAME"       # ëŸ°íƒ€ì„ ìë™ ìƒì„±
      - "TABLE_TYPE"       # enum ì²« ë²ˆì§¸ ê°’ ì‚¬ìš©
      - "EXPORT_PATH"      # Optional - íŒŒì¼ ì €ì¥ ê²½ë¡œ
      - "UNIT"             # Optional - ë‹¨ìœ„ ì„¤ì •
      - "STYLES"           # Optional - ìˆ«ì í¬ë§·
      - "COMPONENTS"       # componentEnumsë¡œ ìƒì„±
      - "NODE_ELEMS"       # Optional - oneOf ì„ íƒ
      - "LOAD_CASE_NAMES"  # Optional - ë¡œë“œ ì¼€ì´ìŠ¤
      - "OPT_CS"           # Optional - boolean
      - "STAGE_STEP"       # Optional - ì¡°ê±´ë¶€
      - "PARTS"            # Optional - All ê¸°ë³¸ê°’
      - "PARTS_CS"         # Optional - All ê¸°ë³¸ê°’
      - "COMP_TENS"        # Optional - All ê¸°ë³¸ê°’
      - "GIRDER_SLAB"      # oneOf ì²« ë²ˆì§¸ ê°’
      - "DISP_OPT"         # Optional
      - "AVERAGE_NODAL_RESULT"  # Optional - boolean
    action:
      type: "suggest_question"
      priority: "low"
      questionTemplate: "What should be the default value for this required field?"

  # íŒ¨í„´ 5: ì¡°ê±´ë¶€ ë¡œì§ì´ ë³µì¡í•¨
  - id: "complex_conditional"
    trigger:
      type: "complexity_check"
      condition: "allOf with multiple nested if/then"
      threshold: 3  # 3ê°œ ì´ìƒì˜ if/then
    action:
      type: "require_question"
      priority: "high"
      questionTemplate: "Please verify the conditional logic for all TYPE combinations"

  # íŒ¨í„´ 6: í…Œì´ë¸” ìŠ¤í‚¤ë§ˆì—ì„œ COMPONENTS enum ëˆ„ë½
  - id: "missing_table_headers"
    trigger:
      type: "field_analysis"
      condition: "COMPONENTS field exists but enum is empty or missing"
      fieldName: "COMPONENTS"
    action:
      type: "require_question"
      priority: "critical"
      questionTemplate: "Please extract ALL table column headers visible in the image"
      contextTemplate: "COMPONENTS field detected but enum values are missing. Table headers (Elem, Part, CHK, FT, FB, etc.) must be explicitly listed."
    example:
      field: "COMPONENTS"
      trigger: "Table schema with empty COMPONENTS enum"
      question: "What are ALL the column headers visible in the result table? (e.g., Elem, Part, Girder/Slab, Comp./Tens., Stage, CHK, FT, FB, FTL, FBL, FTR, FBR, FMAX, ALW)"

# ============================================================================
# DETERMINISTIC RULES - ì¬í˜„ì„± ë³´ì¥
# ============================================================================
validationStrictness:
  # ê·¼ê±° ì—†ëŠ” enum â†’ ìë™ reject
  missingEvidenceForEnum:
    action: "reject"
    message: "Enum values require evidence (source + ref)"
  
  # ê·¼ê±° ì—†ëŠ” default â†’ warning
  missingEvidenceForDefault:
    action: "warn"
    message: "Default value should have evidence"
  
  # ì˜ì‹¬ìŠ¤ëŸ¬ìš´ confidence â†’ ì§ˆë¬¸ ìƒì„±
  lowConfidenceEvidence:
    action: "generate_question"
    threshold: "low"
    message: "Low confidence evidence detected - verification needed"

# ============================================================================
# DETERMINISTIC RULES - ì¬í˜„ì„± ë³´ì¥
# ============================================================================
deterministicRules:
  # í•„ë“œ ìˆœì„œ í‘œì¤€í™”
  enforceFieldOrder: true
  fieldOrderPriority:
    - "type"
    - "description"
    - "enum"
    - "default"
    - "oneOf"
    - "x-ui"
    - "x-evidence"
  
  # enum ê°’ ì •ë ¬
  sortEnumValues: false  # ì›ë³¸ ìˆœì„œ ìœ ì§€ (UI ìˆœì„œ ì¤‘ìš”)
  
  # ì¼ê´€ëœ key naming
  enforceKeyNamingConvention: true
  namingConvention:
    prefix: "hungarian"  # i, b, d, s, n
    casing: "UPPER_AFTER_PREFIX"  # iTENDON_TYPE, bCHECK

# ============================================================================
# QUALITY GATES - í’ˆì§ˆ ê´€ë¬¸
# ============================================================================
qualityGates:
  # Gate 1: Schema Structure (í•­ìƒ í•„ìˆ˜)
  schemaStructure:
    enabled: true
    checks:
      - "valid_json_schema"
      - "no_unknown_markers"
      - "correct_wrapper_pattern"
  
  # Gate 2: Evidence Completeness
  evidenceCompleteness:
    enabled: true
    minimumCoverage: 0.8  # 80% í•„ë“œì— ê·¼ê±° í•„ìš”
    criticalFields:  # ì´ í•„ë“œë“¤ì€ 100% ê·¼ê±° í•„ìš”
      - "enum"
      - "oneOf"
  
  # Gate 3: Question Quality
  questionQuality:
    enabled: true
    minimumQuestions: 0
    maximumQuestions: 10  # ë„ˆë¬´ ë§ìœ¼ë©´ í’ˆì§ˆ ë¬¸ì œ
    requireContext: true  # ëª¨ë“  ì§ˆë¬¸ì— context í•„ìš”

# ============================================================================
# HALLUCINATION PREVENTION - Hallucination ë°©ì§€
# ============================================================================
hallucinationPrevention:
  # ë¬¸ì„œì— ì—†ëŠ” í•„ë“œ ê°ì§€
  detectUndocumentedFields:
    enabled: true
    action: "require_evidence"
  
  # ì¼ë°˜ì ì´ì§€ ì•Šì€ enum ê°’ ê°ì§€
  detectUnusualEnumValues:
    enabled: true
    knownPatterns:
      - "TYPE values: BEAM, TRUSS, PLATE, etc."
      - "Boolean checkboxes: 0 (unchecked), 1 (checked)"
    action: "flag_for_review"
  
  # Default ê°’ ì¶”ì¸¡ ê¸ˆì§€
  prohibitInferredDefaults:
    enabled: true
    allowedSources: ["doc", "image", "api_spec"]
    prohibitedSources: ["inferred"]
